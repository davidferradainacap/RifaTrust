{% extends 'admin_panel/base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}Gesti√≥n de Rifas{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_panel:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active" aria-current="page">Gesti√≥n de Rifas</li>
{% endblock %}

{% block page_title %}Gesti√≥n de Rifas{% endblock %}
{% block page_subtitle %}Administraci√≥n y monitoreo de todas las rifas{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary btn-sm" onclick="location.reload()">
        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
    </button>
    <a href="{% url 'admin_panel:export_raffles_pdf' %}" class="btn btn-outline-danger btn-sm">
        <i class="bi bi-file-earmark-pdf me-1"></i>Exportar PDF
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Statistics Grid -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-gift fs-3 text-primary"></i>
                <h3 class="mt-2 mb-0">{{ total_raffles }}</h3>
                <small class="text-muted">Total Rifas</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-check-circle fs-3 text-success"></i>
                <h3 class="mt-2 mb-0">{{ raffles_activas }}</h3>
                <small class="text-muted">Activas</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-hourglass-split fs-3 text-secondary"></i>
                <h3 class="mt-2 mb-0">{{ raffles_finalizadas }}</h3>
                <small class="text-muted">Finalizadas</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-x-circle fs-3 text-danger"></i>
                <h3 class="mt-2 mb-0">{{ raffles_canceladas }}</h3>
                <small class="text-muted">Canceladas</small>
            </div>
        </div>
    </div>
</div>

<!-- Filters Section -->
<div class="filters-container">
    <form method="get" action="" id="filtersForm">
        <div class="row g-3">
            <!-- Search -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">
                    <i class="bi bi-search me-1"></i>B√∫squeda
                </label>
                <input type="text" name="search" class="form-control" 
                       placeholder="Buscar por t√≠tulo, organizador o ID..." 
                       value="{{ current_search|default:'' }}">
            </div>
            
            <!-- Estado Filter -->
            <div class="col-md-3">
                <label class="form-label fw-semibold">
                    <i class="bi bi-funnel me-1"></i>Estado
                </label>
                <select name="estado" class="form-select">
                    <option value="">Todos</option>
                    <option value="activa" {% if request.GET.estado == 'activa' %}selected{% endif %}>Activa</option>
                    <option value="finalizada" {% if request.GET.estado == 'finalizada' %}selected{% endif %}>Finalizada</option>
                    <option value="cancelada" {% if request.GET.estado == 'cancelada' %}selected{% endif %}>Cancelada</option>
                    <option value="borrador" {% if request.GET.estado == 'borrador' %}selected{% endif %}>Borrador</option>
                </select>
            </div>
            
            <!-- Date Range -->
            <div class="col-md-2">
                <label class="form-label fw-semibold">
                    <i class="bi bi-calendar me-1"></i>Desde
                </label>
                <input type="date" name="fecha_desde" class="form-control" value="{{ request.GET.fecha_desde|default:'' }}">
            </div>
            
            <div class="col-md-2">
                <label class="form-label fw-semibold">
                    <i class="bi bi-calendar me-1"></i>Hasta
                </label>
                <input type="date" name="fecha_hasta" class="form-control" value="{{ request.GET.fecha_hasta|default:'' }}">
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel me-1"></i>Aplicar Filtros
                </button>
                <a href="{% url 'admin_panel:raffles_management' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Raffles Table -->
<div class="table-card mt-4">
    <div class="table-card-header">
        <h5 class="table-card-title mb-0">
            <i class="bi bi-list-ul me-2"></i>
            Rifas ({{ raffles.count }} total)
        </h5>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√≠tulo</th>
                            <th>Organizador</th>
                            <th>Precio Boleto</th>
                            <th>Boletos</th>
                            <th>Estado</th>
                            <th>Fecha Sorteo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for raffle in raffles %}
                        <tr>
                            <td>{{ raffle.id }}</td>
                            <td>
                                <strong>{{ raffle.titulo|truncatechars:40 }}</strong>
                                <br><small class="text-muted">{{ raffle.premio_principal }}</small>
                            </td>
                            <td>
                                {{ raffle.organizador.nombre }}<br>
                                <small class="text-muted">{{ raffle.organizador.email }}</small>
                            </td>
                            <td><strong>CLP${{ raffle.precio_boleto|floatformat:0|intcomma }}</strong></td>
                            <td>
                                {{ raffle.boletos_vendidos }}/{{ raffle.total_boletos }}
                                <br>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         data-width="{{ raffle.porcentaje_vendido|floatformat:0 }}"></div>
                                </div>
                                <small class="text-muted">{{ raffle.porcentaje_vendido|floatformat:0 }}%</small>
                            </td>
                            <td>
                                {% if raffle.estado == 'activa' %}
                                    <span class="badge bg-success">‚úì Activa</span>
                                {% elif raffle.estado == 'borrador' %}
                                    <span class="badge bg-secondary">üìù Borrador</span>
                                {% elif raffle.estado == 'cerrada' %}
                                    <span class="badge bg-warning">üîí Cerrada</span>
                                {% elif raffle.estado == 'finalizada' %}
                                    <span class="badge bg-info">‚úîÔ∏è Finalizada</span>
                                {% elif raffle.estado == 'cancelada' %}
                                    <span class="badge bg-danger">‚úó Cancelada</span>
                                {% endif %}
                            </td>
                            <td><small>{{ raffle.fecha_sorteo|date:"d/m/Y H:i" }}</small></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'raffles:detail' raffle.id %}" class="btn btn-info" title="Ver detalles">
                                        üëÅÔ∏è
                                    </a>
                                    <button class="btn btn-warning" title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    {% if raffle.estado == 'activa' %}
                                    <button class="btn btn-danger" title="Cancelar">
                                        üö´
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                No hay rifas registradas
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5>Total Rifas</h5>
                    <h2>{{ total_raffles }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5>Activas</h5>
                    <h2>{{ raffles_activas }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h5>Finalizadas</h5>
                    <h2>{{ raffles_finalizadas }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-danger text-white">
                <div class="card-body">
                    <h5>Canceladas</h5>
                    <h2>{{ raffles_canceladas }}</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    border: 1px solid rgba(0,0,0,0.125);
}

.progress {
    margin-top: 3px;
}

/* Responsive Design */

/* Tablets (max-width: 992px) */
@media (max-width: 992px) {
    .col-md-3 {
        width: 50% !important;
    }
    
    .btn-group {
        flex-direction: column !important;
    }
    
    .btn-group .btn {
        width: 100% !important;
        margin-bottom: 0.5rem !important;
    }
}

/* M√≥viles (max-width: 768px) */
@media (max-width: 768px) {
    .col-md-3 {
        width: 100% !important;
    }
    
    /* Stats cards */
    .card-body {
        padding: 1rem !important;
    }
    
    .card-body h3 {
        font-size: 1.5rem !important;
    }
    
    .fs-3 {
        font-size: 2rem !important;
    }
    
    /* Tabla responsive */
    .table-responsive {
        font-size: 0.85rem !important;
    }
    
    .table th,
    .table td {
        padding: 0.5rem !important;
    }
    
    /* Ocultar columnas menos importantes */
    .table td:nth-child(3),
    .table th:nth-child(3),
    .table td:nth-child(4),
    .table th:nth-child(4) {
        display: none !important;
    }
    
    /* Badges y botones */
    .badge {
        font-size: 0.75rem !important;
        padding: 0.25rem 0.5rem !important;
    }
    
    .btn {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.85rem !important;
    }
    
    .btn-sm {
        padding: 0.35rem 0.6rem !important;
        font-size: 0.8rem !important;
    }
    
    /* Pagination */
    .pagination {
        font-size: 0.85rem !important;
    }
    
    .page-link {
        padding: 0.375rem 0.75rem !important;
    }
}

/* M√≥viles peque√±os (max-width: 576px) */
@media (max-width: 576px) {
    .card-body h3 {
        font-size: 1.25rem !important;
    }
    
    .card-body small {
        font-size: 0.75rem !important;
    }
    
    /* Ocultar m√°s columnas */
    .table td:nth-child(2),
    .table th:nth-child(2),
    .table td:nth-child(5),
    .table th:nth-child(5) {
        display: none !important;
    }
    
    .btn-sm {
        padding: 0.3rem 0.5rem !important;
        font-size: 0.75rem !important;
    }
    
    .pagination {
        font-size: 0.8rem !important;
    }
    
    .page-link {
        padding: 0.3rem 0.6rem !important;
    }
}

/* Prevenir overflow horizontal */
@media (max-width: 768px) {
    body {
        overflow-x: hidden !important;
    }
    
    .container-fluid {
        overflow-x: hidden !important;
    }
    
    .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    [class*="col-"] {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.progress-bar').forEach(function(bar) {
        const width = bar.getAttribute('data-width');
        if (width) {
            bar.style.width = width + '%';
        }
    });
});
</script>
{% endblock %}
