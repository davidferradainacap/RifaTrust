{% extends "base.html" %}
{% load humanize %}

{% block title %}Todas las Rifas{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div>
        <h1 class="dashboard-title">Rifas Disponibles</h1>
        <p class="dashboard-subtitle">Explora todas las rifas</p>
    </div>
</div>

<!-- Filtros -->
<div style="margin-bottom: 2rem;">
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; align-items: center;">
        <a href="?estado=activa" class="btn {% if estado_filter == 'activa' or not estado_filter %}btn-primary{% else %}btn-secondary{% endif %}" style="padding: 0.75rem 1.5rem; min-width: 140px;">
            ğŸ¯ Activas
        </a>
        <a href="?estado=finalizada" class="btn {% if estado_filter == 'finalizada' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding: 0.75rem 1.5rem; min-width: 140px;">
            âœ… Finalizadas
        </a>
        <a href="?estado=todas" class="btn {% if estado_filter == 'todas' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding: 0.75rem 1.5rem; min-width: 140px;">
            ğŸ“‹ Todas
        </a>
    </div>
</div>

<!-- Contador de rifas -->
<div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 4px solid var(--primary);">
    <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
        {% if estado_filter == 'activa' %}
            Mostrando <strong style="color: var(--primary);">{{ raffles.count }}</strong> rifa{{ raffles.count|pluralize }} activa{{ raffles.count|pluralize }}
        {% elif estado_filter == 'finalizada' %}
            Mostrando <strong style="color: var(--primary);">{{ raffles.count }}</strong> rifa{{ raffles.count|pluralize }} finalizada{{ raffles.count|pluralize }}
        {% else %}
            Mostrando <strong style="color: var(--primary);">{{ raffles.count }}</strong> rifa{{ raffles.count|pluralize }} en total
        {% endif %}
    </span>
</div>

{% if raffles %}
<div class="raffles-grid">
    {% for raffle in raffles %}
    <div class="raffle-card">
        <div class="raffle-image">
            {% if raffle.imagen %}
                <img src="{{ raffle.imagen.url }}" alt="{{ raffle.titulo }}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22200%22%3E%3Crect fill=%22%23667eea%22 width=%22400%22 height=%22200%22/%3E%3Ctext fill=%22white%22 font-family=%22Arial%22 font-size=%2224%22 text-anchor=%22middle%22 x=%22200%22 y=%22110%22%3EğŸŸï¸ Rifa%3C/text%3E%3C/svg%3E'">
            {% else %}
                <img src="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22200%22%3E%3Crect fill=%22%23667eea%22 width=%22400%22 height=%22200%22/%3E%3Ctext fill=%22white%22 font-family=%22Arial%22 font-size=%2224%22 text-anchor=%22middle%22 x=%22200%22 y=%22110%22%3EğŸŸï¸ Rifa%3C/text%3E%3C/svg%3E" alt="{{ raffle.titulo }}">
            {% endif %}
            {% if raffle.estado == 'activa' %}
                <span class="badge badge-success" style="position: absolute; top: 1rem; right: 1rem;">ğŸ¯ Activa</span>
            {% elif raffle.estado == 'finalizada' %}
                <span class="badge" style="position: absolute; top: 1rem; right: 1rem; background: #4299e1;">âœ… Finalizada</span>
            {% else %}
                <span class="badge badge-warning" style="position: absolute; top: 1rem; right: 1rem;">{{ raffle.estado|title }}</span>
            {% endif %}
        </div>
        <div class="raffle-content">
            <h3 class="raffle-title">{{ raffle.titulo }}</h3>
            <p class="raffle-description">{{ raffle.descripcion|truncatewords:20 }}</p>

            <div class="raffle-prize">
                <span class="prize-icon">ğŸ†</span>
                <span class="prize-text">{{ raffle.premio_principal }}</span>
            </div>

            <div class="raffle-info">
                <div class="info-item">
                    <span class="info-label">Precio:</span>
                    <span class="info-value">CLP${{ raffle.precio_boleto|floatformat:0|intcomma }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Boletos Vendidos:</span>
                    <span class="info-value">{{ raffle.boletos_vendidos }}/{{ raffle.total_boletos }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Sorteo:</span>
                    <span class="info-value">{{ raffle.fecha_sorteo|date:"d/m/Y" }}</span>
                </div>
            </div>

            <div style="margin-top: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <span style="color: rgba(255, 255, 255, 0.6);">Progreso</span>
                    <span style="font-weight: 600; color: var(--primary);">{{ raffle.porcentaje_vendido|floatformat:0 }}%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" data-width="{{ raffle.porcentaje_vendido }}"></div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-direction: column; position: relative; z-index: 2;">
                <!-- BotÃ³n de Ruleta para rifas con sorteo prÃ³ximo (fecha dentro de 7 dÃ­as) -->
                {% now "U" as current_timestamp %}
                {% if raffle.fecha_sorteo|date:"U"|add:"604800" >= current_timestamp %}
                    <a href="/raffles/{{ raffle.id }}/#roulette-section" class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: bold; border: none; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); position: relative; z-index: 2;">
                        ğŸ° VER RULETA EN VIVO ğŸ°
                    </a>
                {% endif %}

                <div style="display: flex; gap: 0.75rem;">
                    <a href="/raffles/{{ raffle.id }}/" class="btn btn-primary" style="flex: 1; position: relative; z-index: 2;">Ver Detalles</a>
                    {% if raffle.estado == 'finalizada' %}
                        <a href="{% url 'raffles:acta_sorteo' raffle.id %}" class="btn" style="flex: 1; position: relative; z-index: 2; background: #4299e1; color: white;">ğŸ“œ Ver Acta</a>
                    {% elif user.is_authenticated and raffle.esta_disponible %}
                        {% if user.rol != 'organizador' %}
                        <a href="/raffles/{{ raffle.id }}/buy/" class="btn btn-secondary" style="flex: 1; position: relative; z-index: 2;">Comprar Boleto</a>
                        {% else %}
                        <span class="btn btn-secondary" style="flex: 1; position: relative; z-index: 2; opacity: 0.5; cursor: not-allowed;" title="Los organizadores no pueden comprar boletos">ğŸš« Solo VisualizaciÃ³n</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸŸï¸</div>
    <h2 style="font-size: 1.5rem; font-weight: 600; color: rgba(255, 255, 255, 0.9); margin-bottom: 0.5rem;">
        No hay rifas disponibles
    </h2>
    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 2rem;">
        Por el momento no hay rifas activas. Â¡Vuelve pronto!
    </p>
    {% if user.is_authenticated and user.rol == 'organizador' %}
    <a href="/raffles/create/" class="btn btn-primary">Crear Primera Rifa</a>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Aplicar filtro desde el select
function aplicarFiltro() {
    const estado = document.getElementById('estadoFilter').value;
    window.location.href = '?estado=' + estado;
}

(function() {
    document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar) {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
})();
</script>
{% endblock %}
