{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ raffle.titulo }}{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
    
    <!-- Header -->
    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div>
            {% if raffle.imagen %}
                <img src="{{ raffle.imagen.url }}" alt="{{ raffle.titulo }}" style="width: 100%; height: 400px; object-fit: cover; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            {% else %}
                <div style="width: 100%; height: 400px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 6rem;">üéüÔ∏è</div>
            {% endif %}
        </div>
        
        <div style="background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <h1 style="font-size: 2rem; margin-bottom: 1.5rem;">{{ raffle.titulo }}</h1>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                <div style="font-size: 0.75rem; color: #718096; text-transform: uppercase;">Premio</div>
                <div style="font-weight: 600; color: #2d3748; font-size: 1.1rem;">{{ raffle.premio_principal }}</div>
            </div>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                <div style="font-size: 0.75rem; color: #718096; text-transform: uppercase;">Fecha Sorteo</div>
                <div style="font-weight: 600; color: #2d3748; font-size: 1.1rem;">{{ raffle.fecha_sorteo|date:"d/m/Y H:i" }}</div>
            </div>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                <div style="font-size: 0.75rem; color: #718096; text-transform: uppercase;">Precio</div>
                <div style="font-weight: 700; color: #48bb78; font-size: 1.5rem;">${{ raffle.precio_boleto|intcomma }}</div>
            </div>
            <div style="margin-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.875rem; color: #718096;">Boletos vendidos</span>
                    <span style="font-weight: 600;">{{ sold_tickets }} / {{ raffle.total_boletos }}</span>
                </div>
                <div style="background: #e2e8f0; border-radius: 50px; height: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: {{ progress_percentage }}%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Countdown -->
    <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 2rem; border-radius: 16px; text-align: center; margin: 2rem 0; color: white; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);">
        <div style="font-size: 1.2rem; margin-bottom: 1rem;">‚è∞ Tiempo restante para el sorteo</div>
        <div id="countdown" style="font-size: 3rem; font-weight: 900; color: #ffd700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);">Cargando...</div>
    </div>
    
    <!-- Ruleta -->
    {% if show_roulette %}
    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 3rem; border-radius: 20px; margin: 2rem 0; box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 4px solid #ffd700;">
        <h2 style="text-align: center; font-size: 2.5rem; color: #ffd700; margin-bottom: 2rem; text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);">üé∞ RULETA DE LA FORTUNA üé∞</h2>
        
        <div style="position: relative; width: 500px; height: 500px; margin: 0 auto;">
            <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-top: 50px solid #ff0000; filter: drop-shadow(0 5px 15px rgba(255, 0, 0, 0.8)); z-index: 100;"></div>
            <canvas id="roulette" width="500" height="500" style="border-radius: 50%; box-shadow: 0 0 60px rgba(255, 215, 0, 0.4);"></canvas>
        </div>
        
        <div id="status" style="text-align: center; margin-top: 2rem; padding: 1.5rem; background: rgba(0,0,0,0.3); border-radius: 12px; color: white; font-size: 1.3rem; font-weight: bold;">‚è≥ Esperando inicio del sorteo...</div>
    </div>
    
    <!-- Modal Ganador -->
    <div id="winnerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #ffd700, #ffed4e); padding: 4rem; border-radius: 30px; text-align: center; max-width: 600px; box-shadow: 0 30px 100px rgba(255, 215, 0, 0.6);">
            <h1 style="font-size: 4rem; color: #ff0000; margin-bottom: 2rem;">üéâ ¬°GANADOR! üéâ</h1>
            <div style="background: white; padding: 2rem; border-radius: 20px; margin: 2rem 0;">
                <div style="font-size: 3rem; font-weight: 900; color: #ff0000;">Boleto #<span id="winnerTicket">0</span></div>
                <div id="winnerName" style="font-size: 2rem; font-weight: bold; color: #333; margin-top: 1rem;">Nombre</div>
            </div>
            <button onclick="document.getElementById('winnerModal').style.display='none'" style="margin-top: 2rem; padding: 1rem 3rem; background: #ff0000; color: white; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 10px 30px rgba(255, 0, 0, 0.4);">Cerrar</button>
        </div>
    </div>
    
    <!-- Participantes -->
    <div style="background: white; padding: 2rem; border-radius: 16px; margin-top: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem;">üë• Participantes ({{ sold_tickets }} boletos vendidos)</h3>
        <div id="participants">
            {% for ticket in tickets %}
            <div data-ticket-id="{{ ticket.id }}" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; margin-bottom: 0.5rem; background: #f7fafc; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">{{ ticket.numero_boleto }}</div>
                    <div>
                        <div style="font-weight: 600; color: #2d3748;">{{ ticket.usuario.nombre }}</div>
                        <div style="font-size: 0.875rem; color: #718096;">{{ ticket.usuario.email }}</div>
                    </div>
                </div>
                <span style="background: #48bb78; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600;">PAGADO</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Descripci√≥n -->
    <div style="background: white; padding: 2rem; border-radius: 16px; margin-top: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <h3 style="font-size: 1.3rem; margin-bottom: 1rem;">üìù Descripci√≥n</h3>
        <p style="color: #4a5568; line-height: 1.8;">{{ raffle.descripcion|default:"Sin descripci√≥n disponible." }}</p>
    </div>
    
</div>

<script>
(function() {
    'use strict';
    
    const RAFFLE_DATE = new Date({{ fecha_sorteo_timestamp }});
    const RAFFLE_ID = {{ raffle.id }};
    const CSRF = '{{ csrf_token }}';
    
    let sorteoRealizado = false;
    let spinning = false;
    let winner = null;
    
    // COUNTDOWN
    function updateCountdown() {
        const el = document.getElementById('countdown');
        if (!el) return;
        
        const now = new Date();
        const diff = RAFFLE_DATE - now;
        
        if (diff <= 0) {
            if (!sorteoRealizado) {
                el.textContent = '¬°INICIANDO SORTEO!';
                sorteoRealizado = true;
                setTimeout(iniciarSorteo, 2000);
            } else {
                el.textContent = '¬°SORTEO FINALIZADO!';
            }
            return;
        }
        
        const d = Math.floor(diff / 86400000);
        const h = Math.floor((diff % 86400000) / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        
        let time = '';
        if (d > 0) time += d + 'd ';
        if (h > 0 || d > 0) time += h + 'h ';
        if (m > 0 || h > 0 || d > 0) time += m + 'm ';
        time += s + 's';
        
        el.textContent = time;
    }
    
    updateCountdown();
    setInterval(updateCountdown, 1000);
    
    {% if show_roulette %}
    
    const canvas = document.getElementById('roulette');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    
    const tickets = {{ tickets_json|safe }};
    console.log('Tickets:', tickets);
    
    if (!tickets || tickets.length === 0) {
        statusEl.textContent = '‚ö†Ô∏è No hay participantes';
    }
    
    let rotation = 0;
    let targetRotation = 0;
    let velocity = 0;
    let animating = false;
    
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];
    
    function draw() {
        if (tickets.length === 0) return;
        
        const cx = 250, cy = 250, r = 220;
        const angle = (2 * Math.PI) / tickets.length;
        
        ctx.clearRect(0, 0, 500, 500);
        
        tickets.forEach((t, i) => {
            const start = rotation + (angle * i);
            const end = start + angle;
            
            ctx.beginPath();
            ctx.arc(cx, cy, r, start, end);
            ctx.lineTo(cx, cy);
            ctx.fillStyle = colors[i % colors.length];
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(start + angle / 2);
            ctx.textAlign = 'center';
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('#' + t.numero_boleto, r - 60, 5);
            ctx.font = '12px Arial';
            ctx.fillText(t.nombre.substring(0, 15), r - 60, 20);
            ctx.restore();
        });
        
        ctx.beginPath();
        ctx.arc(cx, cy, 50, 0, 2 * Math.PI);
        ctx.fillStyle = '#ffd700';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 5;
        ctx.stroke();
    }
    
    function animate() {
        if (animating) {
            rotation += velocity;
            velocity *= 0.98;
            
            if (Math.abs(velocity) < 0.001) {
                animating = false;
                velocity = 0;
                rotation = targetRotation;
                anunciar();
            }
            
            draw();
            requestAnimationFrame(animate);
        }
    }
    
    function spin(w) {
        if (spinning || tickets.length === 0) return;
        spinning = true;
        animating = true;
        
        statusEl.textContent = 'üé∞ Girando la ruleta...';
        
        const idx = tickets.findIndex(t => t.id === w.id);
        if (idx === -1) return;
        
        const angle = (2 * Math.PI) / tickets.length;
        const winnerAngle = angle * idx;
        const spins = 5 + Math.random() * 3;
        targetRotation = (spins * 2 * Math.PI) - winnerAngle - (angle / 2);
        
        velocity = 0.5;
        animate();
    }
    
    function anunciar() {
        if (!winner) return;
        
        statusEl.textContent = 'üéâ ¬°GANADOR: #' + winner.numero_boleto + ' - ' + winner.nombre + '!';
        
        const item = document.querySelector('[data-ticket-id="' + winner.id + '"]');
        if (item) {
            item.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
            item.style.border = '3px solid #ff0000';
            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        setTimeout(() => {
            document.getElementById('winnerTicket').textContent = winner.numero_boleto;
            document.getElementById('winnerName').textContent = winner.nombre;
            document.getElementById('winnerModal').style.display = 'flex';
            confetti();
        }, 1500);
        
        spinning = false;
    }
    
    function confetti() {
        for (let i = 0; i < 100; i++) {
            setTimeout(() => {
                const c = document.createElement('div');
                c.style.cssText = 'position:fixed;width:10px;height:10px;background:' + colors[Math.floor(Math.random()*colors.length)] + ';left:' + Math.random()*100 + '%;top:-20px;';
                document.body.appendChild(c);
                const anim = c.animate([
                    { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                    { transform: 'translateY(100vh) rotate(720deg)', opacity: 0 }
                ], { duration: 4000 });
                anim.onfinish = () => c.remove();
            }, i * 30);
        }
    }
    
    function iniciarSorteo() {
        if (spinning) return;
        
        statusEl.textContent = 'üé≤ Seleccionando ganador...';
        
        fetch('/raffles/' + RAFFLE_ID + '/select-winner/', {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF, 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                winner = data.winner;
                setTimeout(() => spin(winner), 500);
            } else {
                statusEl.textContent = '‚ùå Error: ' + data.error;
            }
        })
        .catch(err => {
            statusEl.textContent = '‚ùå Error de conexi√≥n';
        });
    }
    
    window.iniciarSorteo = iniciarSorteo;
    
    fetch('/raffles/' + RAFFLE_ID + '/check-winner/')
        .then(r => r.json())
        .then(data => {
            if (data.has_winner) {
                winner = data.winner;
                sorteoRealizado = true;
                statusEl.textContent = 'üèÜ GANADOR: #' + winner.numero_boleto + ' - ' + winner.nombre;
                const item = document.querySelector('[data-ticket-id="' + winner.id + '"]');
                if (item) {
                    item.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                    item.style.border = '3px solid #ff0000';
                }
            } else {
                draw();
            }
        });
    
    setInterval(() => {
        if (!sorteoRealizado && new Date() >= RAFFLE_DATE) {
            fetch('/raffles/' + RAFFLE_ID + '/check-winner/')
                .then(r => r.json())
                .then(data => {
                    if (data.has_winner && !winner) {
                        winner = data.winner;
                        sorteoRealizado = true;
                        spin(winner);
                    }
                });
        }
    }, 3000);
    
    {% endif %}
    
})();
</script>

{% endblock %}
