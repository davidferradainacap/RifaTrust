<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="RifaTrust - Sistema de Rifas Seguro y Transparente">
    <title>{% block title %}Sistema de Rifas{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéüÔ∏è</text></svg>">

    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/raffle_glass.css">
    <link rel="stylesheet" href="/static/css/loading.css">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navegaci√≥n -->
    <nav class="navbar glass-navbar">
        <div class="container nav-flex">
            <a href="/" class="logo">
                <span class="logo-icon">üéüÔ∏è</span>
                <span class="logo-text">RifaTrust</span>
            </a>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Men√∫">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
            <div class="nav-links" id="navLinks">
                <a href="/">Inicio</a>
                <a href="/raffles/">Rifas</a>
                {% if user.is_authenticated %}
                    <a href="/dashboard/">Dashboard</a>
                    {% if user.rol == 'organizador' or user.rol == 'admin' %}
                        <a href="/raffles/create/">Crear Rifa</a>
                    {% endif %}

                    <!-- Buz√≥n de Notificaciones -->
                    <div class="notifications-wrapper" style="position: relative;">
                        <button id="notificationsBtn" class="notifications-btn" title="Notificaciones" style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 0.5rem 0.75rem; cursor: pointer; position: relative; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                            </svg>
                            <span id="notificationBadge" class="notification-badge" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.65rem; font-weight: 700; display: none; align-items: center; justify-content: center;">0</span>
                        </button>
                        <div id="notificationsDropdown" class="notifications-dropdown" style="position: absolute; top: calc(100% + 0.5rem); right: 0; background: rgba(30, 41, 59, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; width: 360px; max-height: 500px; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); z-index: 1000; display: none;">
                            <div style="padding: 1rem; border-bottom: 1px solid rgba(99, 102, 241, 0.2); display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="color: white; font-size: 1.1rem; font-weight: 700; margin: 0;">üîî Notificaciones</h3>
                                <a href="/notifications/" style="color: #6366f1; font-size: 0.85rem; text-decoration: none; font-weight: 600;">Ver todas</a>
                            </div>
                            <div id="notificationsList" class="notifications-list" style="padding: 0.5rem;">
                                <div class="notifications-loading" style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.6);">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
                                    <p>Cargando...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <a href="/profile/" class="profile-btn" title="Mi Perfil">
                        <span class="profile-avatar">
                            <svg viewBox="0 0 32 32" width="26" height="26" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="15" fill="#fff" stroke="#6366f1" stroke-width="2"/>
                                <circle cx="16" cy="13" r="5" fill="#6366f1"/>
                                <path d="M7 26c2-4 7-4 9-4s7 0 9 4" stroke="#6366f1" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span class="profile-text">Perfil</span>
                    </a>
                    <a href="/logout/" class="btn-secondary btn-sm">Cerrar Sesi√≥n</a>
                {% else %}
                    <a href="/login/" class="btn-secondary btn-sm">Iniciar Sesi√≥n</a>
                    <a href="/register/" class="btn-primary btn-sm">Registrarse</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container">
            <!-- Mensajes -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer style="background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(99, 102, 241, 0.2); padding: 2.5rem 0; margin-top: 4rem;">
        <div class="container text-center">
            <p style="color: white; font-weight: 600; font-size: 1rem;">&copy; 2025 Sistema de Rifas. Todos los derechos reservados.</p>
            <p style="margin-top: 0.75rem; color: rgba(255, 255, 255, 0.6); font-size: 0.95rem;">
                üîí Seguro ‚Ä¢ ‚úÖ Transparente ‚Ä¢ ‚ö° Confiable
            </p>
        </div>
    </footer>

    <!-- Sistema de Loading Global (cargar primero) -->
    <script src="/static/js/loading.js"></script>

    <!-- Main JS (incluye men√∫ hamburguesa) -->
    <script src="/static/js/main.js"></script>

    {% if user.is_authenticated %}
    <script>
        // Gesti√≥n de notificaciones
        const notificationsBtn = document.getElementById('notificationsBtn');
        const notificationsDropdown = document.getElementById('notificationsDropdown');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationsList = document.getElementById('notificationsList');

        let isDropdownOpen = false;

        // Toggle dropdown
        if (notificationsBtn) {
            notificationsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                isDropdownOpen = !isDropdownOpen;
                if (isDropdownOpen) {
                    notificationsDropdown.style.display = 'block';
                    if (notificationsList.querySelector('.notifications-loading')) {
                        loadNotifications();
                    }
                } else {
                    notificationsDropdown.style.display = 'none';
                }
            });
        }

        // Cerrar al hacer click fuera
        document.addEventListener('click', function(e) {
            if (isDropdownOpen && !notificationsDropdown.contains(e.target) && !notificationsBtn.contains(e.target)) {
                isDropdownOpen = false;
                notificationsDropdown.style.display = 'none';
            }
        });

        // Cargar notificaciones
        function loadNotifications() {
            fetch('/notifications/api/list/')
                .then(response => response.json())
                .then(data => {
                    if (data.notifications && data.notifications.length > 0) {
                        // Actualizar badge
                        const unreadCount = data.notifications.filter(n => !n.leido).length;
                        if (unreadCount > 0) {
                            notificationBadge.textContent = unreadCount;
                            notificationBadge.style.display = 'flex';
                        } else {
                            notificationBadge.style.display = 'none';
                        }

                        notificationsList.innerHTML = data.notifications.map(notif => `
                            <div class="notification-item ${notif.leido ? '' : 'unread'}" style="padding: 1rem; border-bottom: 1px solid rgba(99, 102, 241, 0.1); cursor: pointer; transition: background 0.2s; ${notif.leido ? '' : 'background: rgba(99, 102, 241, 0.1);'}">
                                <div style="display: flex; gap: 0.75rem; align-items: start;">
                                    <div style="font-size: 1.5rem; flex-shrink: 0;">
                                        ${getNotificationIcon(notif.tipo)}
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: white; font-size: 0.9rem; margin: 0 0 0.25rem 0; line-height: 1.4;">${notif.mensaje}</p>
                                        <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.75rem;">${notif.created_at}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        notificationBadge.style.display = 'none';
                        notificationsList.innerHTML = '<div style="text-align: center; padding: 3rem 1rem; color: rgba(255, 255, 255, 0.5);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">üì≠</div><p>No hay notificaciones</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    notificationsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.5);">Error al cargar notificaciones</div>';
                });
        }

        // Cargar notificaciones inicial
        loadNotifications();
        // Actualizar cada 30 segundos
        setInterval(loadNotifications, 30000);

        // Icono seg√∫n tipo de notificaci√≥n
        function getNotificationIcon(tipo) {
            const icons = {
                'info': 'üì¢',
                'pago': 'üí∞',
                'rifa': 'üéüÔ∏è',
                'ganador': 'üèÜ',
                'aprobacion': '‚úÖ',
                'rechazo': '‚ùå'
            };
            return icons[tipo] || 'üì¢';
        }
    </script>
    {% endif %}

    {% block extra_js %}{% endblock %}
</body>
</html>
